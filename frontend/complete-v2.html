<!DOCTYPE html> <!--#claude-->
<html lang="en"> <!--#claude-->
<head> <!--#claude-->
    <meta charset="UTF-8"> <!--#claude-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> <!--#claude-->
    <meta name="apple-mobile-web-app-capable" content="yes"> <!--#claude-->
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> <!--#claude-->
    <meta name="apple-mobile-web-app-title" content="FaceData"> <!--#claude-->
    <title>Session Complete - Facial Data Collection</title> <!--#claude-->

    <!-- PWA Manifest --> <!--#claude-->
    <link rel="manifest" href="/manifest.json"> <!--#claude-->
    <link rel="apple-touch-icon" href="/icons/icon-192.png"> <!--#claude-->
    <meta name="theme-color" content="#007aff"> <!--#claude-->

    <!-- Styles --> <!--#claude-->
    <link rel="stylesheet" href="/css/styles.css"> <!--#claude-->
</head> <!--#claude-->
<body> <!--#claude-->
    <div class="container"> <!--#claude-->
        <div class="completion-screen"> <!--#claude-->
            <h1>Session Complete!</h1> <!--#claude-->
            <p>Thank you for completing all video recordings.</p> <!--#claude-->

            <div id="sessionSummary" class="session-summary"> <!--#claude-->
                <!-- Populated by JavaScript --> <!--#claude-->
            </div> <!--#claude-->

            <div class="button-group">
                <button id="viewDetailsBtn" class="btn btn-secondary">View Details</button>
                <button id="startNewBtn" class="btn btn-warning">Start New Session</button>
                <button id="homeBtn" class="btn btn-primary">Return Home</button>
            </div>

            <div id="detailsSection" class="details-section hidden"> <!--#claude-->
                <h2>Recording Details</h2> <!--#claude-->
                <div id="videoList" class="video-list"> <!--#claude-->
                    <!-- Populated by JavaScript --> <!--#claude-->
                </div> <!--#claude-->
            </div> <!--#claude-->
        </div> <!--#claude-->
    </div> <!--#claude-->

    <script src="/js/dexie.min.js"></script>
    <script src="/js/storage.js?v=20"></script> <!--#claude-->
    <script src="/js/state.js?v=20"></script>
    <script src="/js/uploader.js?v=20"></script> <!--#claude - Video uploader module-->
    <script src="/js/upload-manager.js?v=20"></script> <!--#claude - v20: TEST_MODE inflation enabled-->

    <script>
        // #claude v41: Prevent browser back navigation on completion page
        (function preventBackNavigation() {
            history.pushState(null, '', window.location.href);
            window.addEventListener('popstate', function(event) {
                console.warn('‚ö†Ô∏è User tried to navigate back from completion page');
                history.pushState(null, '', window.location.href);
                alert('‚ö†Ô∏è Please use the "Start New Session" button to continue.');
            });
            console.log('üîí V41: Back navigation prevention active on completion page');
        })();
    </script>

    <script>
        (async function() {
            try {
                console.log('üéâ Loading session completion details...');

                // #claude - Restore backendSessionId from localStorage so uploads can continue
                const backendSessionId = localStorage.getItem('backendSessionId');
                if (backendSessionId) {
                    window.backendSessionId = backendSessionId;
                    console.log(`‚úÖ Restored backend session: ${backendSessionId}`);
                } else {
                    console.warn('‚ö†Ô∏è No backend session found in localStorage');
                }

                await SessionState.init();

                const summary = SessionState.getSessionSummary();
                console.log('Session summary:', summary);

                // #claude v20: Get video count from upload queue (memory-based architecture means videos deleted from IndexedDB after upload)
                let videoCount = summary.completedCount;
                if (typeof UploadManager !== 'undefined') {
                    const uploadManager = UploadManager.resumeUploads();
                    const queueSummary = uploadManager.getSummary();
                    videoCount = queueSummary.total; // Total videos in upload queue
                    console.log(`üìä Video count from upload queue: ${videoCount}`);
                }

                const sessionSummary = document.getElementById('sessionSummary');
                sessionSummary.innerHTML = `
                    <div class="summary-item">
                        <strong>Session ID:</strong> <span style="word-break: break-all; display: inline-block; max-width: 100%;">${summary.sessionId}</span>
                    </div>
                    <div class="summary-item">
                        <strong>Videos Recorded:</strong> <span>${videoCount} of ${summary.totalVideos}</span>
                    </div>
                    <div class="summary-item">
                        <strong>Status:</strong> <span class="status-complete">Complete ‚úì</span>
                    </div>
                `;

                // #claude v20: Get video details from upload queue (memory-based architecture)
                const videoList = document.getElementById('videoList');
                if (typeof UploadManager !== 'undefined') {
                    const uploadManager = UploadManager.resumeUploads();
                    const queue = uploadManager.queue;
                    console.log('Upload queue:', queue);

                    if (queue.length > 0) {
                        videoList.innerHTML = queue.map((item, index) => {
                            // #claude v20: Handle both camelCase (frontend) and snake_case (backend) metadata
                            const fileSize = item.metadata?.fileSize || item.metadata?.file_size;
                            const originalSize = item.metadata?.originalSize || item.metadata?.original_size;
                            const duration = item.metadata?.duration;
                            const codec = item.metadata?.codec || item.metadata?.videoCodec;
                            const bitrateMbps = item.metadata?.calculatedBitrateMbps || item.metadata?.calculated_bitrate_mbps;

                            return `
                            <div class="video-item">
                                <div class="video-number">Video ${index + 1}</div>
                                <div class="video-info">
                                    <div><strong>Prompt ID:</strong> ${item.promptId}</div>
                                    <div><strong>Status:</strong> ${item.status}</div>
                                    <div><strong>Attempts:</strong> ${item.attempts}</div>
                                    ${originalSize ? `<div><strong>Original Size:</strong> ${(originalSize / 1024 / 1024).toFixed(2)} MB</div>` : ''}
                                    ${fileSize ? `<div><strong>Uploaded Size:</strong> ${(fileSize / 1024 / 1024).toFixed(2)} MB</div>` : ''}
                                    ${duration ? `<div><strong>Duration:</strong> ${duration.toFixed(1)}s</div>` : ''}
                                    ${bitrateMbps ? `<div><strong>Bitrate:</strong> ${bitrateMbps} Mbps</div>` : ''}
                                    ${codec ? `<div><strong>Codec:</strong> ${codec}</div>` : ''}
                                </div>
                            </div>
                        `;
                        }).join('');
                    } else {
                        videoList.innerHTML = '<p>No video details available in upload queue.</p>';
                    }
                } else {
                    videoList.innerHTML = '<p>Upload manager not available.</p>';
                }

                // Event listeners - ADD THESE FIRST so buttons work even if upload hangs <!--#claude-->
                document.getElementById('viewDetailsBtn').addEventListener('click', () => { <!--#claude-->
                    const detailsSection = document.getElementById('detailsSection'); <!--#claude-->
                    detailsSection.classList.toggle('hidden'); <!--#claude-->
                }); <!--#claude-->

                document.getElementById('startNewBtn').addEventListener('click', async () => { // #claude
                    console.log('üîÑ Starting new session...'); // #claude
                    localStorage.clear(); // #claude
                    await FacialStorage.clearAllVideos(); // #claude
                    console.log('‚úÖ Session data cleared'); // #claude
                    window.location.href = '/recording.html'; // #claude
                }); // #claude

                document.getElementById('homeBtn').addEventListener('click', async () => { // #claude
                    console.log('üßπ Cleaning up session data before returning home...'); // #claude
                    localStorage.clear(); // #claude
                    await FacialStorage.clearAllVideos(); // #claude
                    console.log('‚úÖ All session data cleared'); // #claude
                    window.location.href = '/'; // #claude
                }); // #claude

                // Wait for background uploads to complete // #claude
                if (typeof UploadManager !== 'undefined') { // #claude
                    const uploadManager = UploadManager.resumeUploads(); // #claude
                    const summary = uploadManager.getSummary(); // #claude
                    console.log('üìä Upload queue state:', summary); // #claude

                    if (summary.pending > 0 || summary.uploading > 0) { // #claude
                        console.log(`‚è≥ Waiting for ${summary.pending + summary.uploading} uploads to complete...`); // #claude

                        // Show waiting status // #claude
                        const uploadStatusDiv = document.createElement('div'); // #claude
                        uploadStatusDiv.className = 'summary-item'; // #claude
                        uploadStatusDiv.innerHTML = '<strong>Upload Status:</strong> <span class="status-warning">‚è≥ Uploading...</span>'; // #claude
                        sessionSummary.appendChild(uploadStatusDiv); // #claude

                        // Wait with 5 minute timeout (video 3 IndexedDB query can take 2+ minutes) // #claude
                        const result = await uploadManager.waitForCompletion(300000); // #claude

                        // Update status // #claude
                        uploadStatusDiv.remove(); // #claude
                        const finalStatusDiv = document.createElement('div'); // #claude
                        finalStatusDiv.className = 'summary-item'; // #claude

                        if (result.success) { // #claude
                            console.log(`‚úÖ All ${result.completed} uploads complete`); // #claude
                            if (result.failed > 0) { // #claude
                                finalStatusDiv.innerHTML = `<strong>Upload Status:</strong> <span class="status-warning">‚ö†Ô∏è ${result.failed} failed</span>`; // #claude
                            } else { // #claude
                                finalStatusDiv.innerHTML = '<strong>Upload Status:</strong> <span class="status-complete">‚úÖ All uploaded</span>'; // #claude
                            } // #claude
                        } else { // #claude
                            console.error('‚ùå Upload timeout or failure:', result); // #claude
                            finalStatusDiv.innerHTML = `<strong>Upload Status:</strong> <span class="status-error">‚ùå Timeout (${result.pending} pending)</span>`; // #claude
                        } // #claude
                        sessionSummary.appendChild(finalStatusDiv); // #claude
                    } else { // #claude
                        console.log(`‚úÖ All ${summary.completed} uploads already complete`); // #claude
                    } // #claude
                } else { // #claude
                    console.log('‚úÖ All uploads complete (blocking upload strategy)'); // #claude
                } // #claude

                // Auto-cleanup after 30 seconds #claude
                const autoCleanupDelay = 30000; // #claude
                console.log(`‚è∞ Auto-cleanup scheduled: ${autoCleanupDelay/1000}s`); // #claude
                setTimeout(async () => { // #claude
                    console.log('üßπ Auto-cleanup: Clearing all session data...'); // #claude
                    localStorage.clear(); // #claude
                    await FacialStorage.clearAllVideos(); // #claude
                    console.log('‚úÖ Auto-cleanup complete. Session data cleared.'); // #claude
                }, autoCleanupDelay); // #claude

            } catch (err) { <!--#claude-->
                console.error('‚ùå Error loading completion details:', err); <!--#claude-->
                document.getElementById('sessionSummary').innerHTML = ` <!--#claude-->
                    <div class="error-message">Error loading session details.</div> <!--#claude-->
                `; <!--#claude-->
            } <!--#claude-->
        })(); <!--#claude-->
    </script> <!--#claude-->
</body> <!--#claude-->
</html> <!--#claude-->
